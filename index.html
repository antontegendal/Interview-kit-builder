<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ETG Interview Kit Builder</title>
  <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    // Simple icon components
    const Icon = ({ type, size = 20, className = '' }) => {
      const icons = {
        alert: (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
        ),
        check: (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        ),
        loader: (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
            <line x1="12" y1="2" x2="12" y2="6"></line>
            <line x1="12" y1="18" x2="12" y2="22"></line>
            <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
            <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
            <line x1="2" y1="12" x2="6" y2="12"></line>
            <line x1="18" y1="12" x2="22" y2="12"></line>
            <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
            <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
          </svg>
        ),
        download: (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
        ),
        upload: (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
        ),
        file: (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
          </svg>
        ),
        target: (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
            <circle cx="12" cy="12" r="10"></circle>
            <circle cx="12" cy="12" r="6"></circle>
            <circle cx="12" cy="12" r="2"></circle>
          </svg>
        ),
        users: (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
        )
      };
      return icons[type] || null;
    };

    const InterviewKitBuilder = () => {
      const [step, setStep] = useState(1);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      
      const [jobDescription, setJobDescription] = useState('');
      const [roleLevel, setRoleLevel] = useState('');
      const [interviewStages, setInterviewStages] = useState([
        { id: 1, name: 'Stage 1', interviewers: [{ id: 1, name: '' }] }
      ]);
      
      const [jobAnalysis, setJobAnalysis] = useState(null);
      const [competencyMap, setCompetencyMap] = useState(null);
      const [generatedQuestions, setGeneratedQuestions] = useState(null);
      const [finalKits, setFinalKits] = useState(null);
      
      const [expandedInterviewers, setExpandedInterviewers] = useState({});

      const companyValues = `ETG Company Values:

1. Playing to Win
We know we can be #1 in the industry.
Our ambition motivates us to improve ourselves continuously, and we are ready to walk the extra mile. In this exciting ride, we are here to make an impact in our customers', partners', and our own lives while having fun doing it.

2. Sense of Urgency to be Excellent
In a rapidly changing industry we embrace the change, knowing fast decisions and implementation are necessary to succeed. At the same time good is not good enough for us - we relentlessly work to improve quality to the benefit of our customers.

3. Accountability and Cooperation
We thrive in a culture of diligence, trust and mutual respect. We have a solid personal ownership of our tasks, but at the same time, as a high-performing team, we use each other's strengths to reach our common goal. After all, we play as a team; we win as a team!`;

      const leadershipValues = `ETG Leadership Principles:

1. Role Model Corporate Culture
   - "Actions speak louder than words"
   - Know, communicate, repeat, live the values

2. Be Interested, Reachable and Approachable
   - Be communicative and open
   - Actively communicate with team and seek opportunities to influence
   - Secure you are an "easy to go to person"

3. Continuous Constructive Feedback
   - Be fair and relevant
   - Use positive reinforcement
   - Be distinct about expectations

4. Courage to Make Decisions and Be Distinct
   - To not make a decision is to make a decision of inaction
   - Be a changemaker of improvements
   - Be distinct in your communication and ensure individual actions towards objectives

5. Dare to Be Yourself, Dare to Ask for Help
   - Be yourself
   - Combine honesty and professionalism
   - To ask for help is a sign of strength and commitment

6. Team Development & Group Dynamics
   - Know and respect your fellow team members
   - Provide the leadership and conditions your individual team member needs to excel in the corporate culture
   - Actively build a high performing team
   - Implement Hybrid Model
   - Make and take efforts so all geographies are involved

7. Cross Department Cooperation
   - Encourage and support cross department cooperation
   - Speak well of your fellow leaders/teams from other departments
   - We are a "non corporate politics environment" and have no tolerance for personal prestige`;

      const roleLevels = [
        { value: 'F', label: 'Level F - Associate', useLeadership: false },
        { value: 'E', label: 'Level E - Professional', useLeadership: false },
        { value: 'D', label: 'Level D - Team Leader / Senior Professional', useLeadership: false },
        { value: 'C', label: 'Level C - Management', useLeadership: true },
        { value: 'B', label: 'Level B - Senior Management', useLeadership: true },
        { value: 'A3', label: 'Level A3 - Function Head', useLeadership: true },
        { value: 'A2', label: 'Level A2 - Department Head', useLeadership: true }
      ];

      const selectedLevelData = roleLevels.find(level => level.value === roleLevel);

      const handleJobDescriptionFileUpload = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        setLoading(true);
        setError('');

        try {
          const fileExtension = file.name.split('.').pop().toLowerCase();
          
          if (fileExtension === 'pdf') {
            const base64Data = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => {
                const base64 = reader.result.split(",")[1];
                resolve(base64);
              };
              reader.onerror = () => reject(new Error("Failed to read file"));
              reader.readAsDataURL(file);
            });

            const response = await fetch("https://api.anthropic.com/v1/messages", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                model: "claude-sonnet-4-20250514",
                max_tokens: 4000,
                messages: [
                  {
                    role: "user",
                    content: [
                      {
                        type: "document",
                        source: {
                          type: "base64",
                          media_type: "application/pdf",
                          data: base64Data,
                        },
                      },
                      {
                        type: "text",
                        text: "Extract all text content from this job description PDF. Return only the text content, without any additional commentary or formatting.",
                      },
                    ],
                  },
                ],
              })
            });

            if (!response.ok) {
              throw new Error(`Failed to extract PDF text: ${response.status}`);
            }

            const data = await response.json();
            const extractedText = data.content[0].text;
            setJobDescription(extractedText);

          } else if (fileExtension === 'docx' || fileExtension === 'doc') {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            setJobDescription(result.value);
          } else {
            throw new Error('Unsupported file format. Please upload PDF or Word documents.');
          }
        } catch (err) {
          setError(`Error reading file: ${err.message}`);
        } finally {
          setLoading(false);
        }
      };

      const toggleInterviewerExpansion = (stageIdx, intIdx) => {
        const key = `${stageIdx}-${intIdx}`;
        setExpandedInterviewers(prev => ({
          ...prev,
          [key]: !prev[key]
        }));
      };

      const addInterviewer = (stageId) => {
        setInterviewStages(stages =>
          stages.map(stage =>
            stage.id === stageId
              ? {
                  ...stage,
                  interviewers: [
                    ...stage.interviewers,
                    { id: Date.now(), name: '' }
                  ]
                }
              : stage
          )
        );
      };

      const updateInterviewerName = (stageId, interviewerId, name) => {
        setInterviewStages(stages =>
          stages.map(stage =>
            stage.id === stageId
              ? {
                  ...stage,
                  interviewers: stage.interviewers.map(interviewer =>
                    interviewer.id === interviewerId
                      ? { ...interviewer, name }
                      : interviewer
                  )
                }
              : stage
          )
        );
      };

      const addStage = () => {
        setInterviewStages([
          ...interviewStages,
          {
            id: Date.now(),
            name: `Stage ${interviewStages.length + 1}`,
            interviewers: [{ id: Date.now(), name: '' }]
          }
        ]);
      };

      const removeStage = (stageId) => {
        if (interviewStages.length > 1) {
          setInterviewStages(stages => stages.filter(stage => stage.id !== stageId));
        }
      };

      const removeInterviewer = (stageId, interviewerId) => {
        setInterviewStages(stages =>
          stages.map(stage =>
            stage.id === stageId
              ? {
                  ...stage,
                  interviewers: stage.interviewers.filter(
                    interviewer => interviewer.id !== interviewerId
                  )
                }
              : stage
          )
        );
      };

      const runJobAnalysis = async () => {
        setLoading(true);
        setError('');
        
        try {
          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 4000,
              messages: [
                {
                  role: "user",
                  content: `You are an expert talent acquisition analyst. Analyze the provided job description and extract structured information.

CONTEXT:
- Focus on competencies that can be assessed through behavioral interviews
- Consider the role level and its implications for assessment depth
- Role Level: ${selectedLevelData.label}

JOB DESCRIPTION:
${jobDescription}

OUTPUT REQUIREMENTS:
Provide a JSON response with:
1. role_title: string
2. role_level: "${roleLevel}"
3. core_competencies: array of 5-8 key competencies
4. technical_skills: array of hard skills required
5. key_responsibilities: array of 3-5 main responsibilities
6. team_context: string describing team dynamics and collaboration needs
7. requires_leadership_values: ${selectedLevelData.useLeadership}

CRITICAL: 
- Extract only what's explicitly stated or clearly implied.
- Your ENTIRE response must be ONLY valid JSON. DO NOT include any text, explanations, or markdown outside the JSON object.
- DO NOT wrap the JSON in markdown code blocks or backticks.`
                }
              ]
            })
          });

          if (!response.ok) {
            throw new Error(`API request failed: ${response.status}`);
          }

          const data = await response.json();
          let responseText = data.content[0].text;
          
          responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
          
          const analysisData = JSON.parse(responseText);
          setJobAnalysis(analysisData);
          setStep(2);
        } catch (err) {
          setError(`Job Analysis Error: ${err.message}`);
          console.error(err);
        } finally {
          setLoading(false);
        }
      };

      const runCompetencyMapping = async () => {
        setLoading(true);
        setError('');
        
        try {
          const interviewConfig = interviewStages.map(stage => ({
            stage_name: stage.name,
            interviewers: stage.interviewers.map(i => i.name).filter(n => n)
          }));

          const valuesToUse = jobAnalysis.requires_leadership_values
            ? `COMPANY VALUES:\n${companyValues}\n\nLEADERSHIP VALUES (applicable for this leadership role):\n${leadershipValues}`
            : `COMPANY VALUES:\n${companyValues}`;

          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 4000,
              messages: [
                {
                  role: "user",
                  content: `You are a competency mapping specialist with deep knowledge of ETG's company values.

${valuesToUse}

ROLE COMPETENCIES:
${JSON.stringify(jobAnalysis, null, 2)}

INTERVIEW STRUCTURE:
${JSON.stringify(interviewConfig, null, 2)}

YOUR TASK:
Map each core competency to relevant ETG values and distribute them across interview stages to avoid repetition.

MAPPING RULES:
1. Each competency should align with 1-2 values maximum
2. ${jobAnalysis.requires_leadership_values ? 'Prioritize leadership values for this leadership role' : 'Focus on company values'}
3. Distribute competencies evenly across stages
4. Assign 2-3 competencies per interviewer
5. Ensure no competency is assessed by multiple interviewers

OUTPUT FORMAT (JSON ONLY):
{
  "stages": [
    {
      "stage_name": "Stage 1",
      "interviewers": [
        {
          "interviewer_name": "John Doe",
          "competencies": ["competency1", "competency2"],
          "values_alignment": ["value1", "value2"],
          "focus_area": "brief description"
        }
      ]
    }
  ]
}

CRITICAL: Your ENTIRE response must be ONLY valid JSON.`
                }
              ]
            })
          });

          if (!response.ok) {
            throw new Error(`API request failed: ${response.status}`);
          }

          const data = await response.json();
          let responseText = data.content[0].text;
          responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
          
          const mappingData = JSON.parse(responseText);
          setCompetencyMap(mappingData);
          setStep(3);
        } catch (err) {
          setError(`Competency Mapping Error: ${err.message}`);
          console.error(err);
        } finally {
          setLoading(false);
        }
      };

      const runQuestionGeneration = async () => {
        setLoading(true);
        setError('');
        
        try {
          const allQuestions = { stages: [] };

          for (const stage of competencyMap.stages) {
            const stageQuestions = { stage_name: stage.stage_name, interviewers: [] };

            for (const interviewer of stage.interviewers) {
              const response = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  model: "claude-sonnet-4-20250514",
                  max_tokens: 4000,
                  messages: [
                    {
                      role: "user",
                      content: `You are an expert behavioral interview designer.

CONTEXT:
Role: ${jobAnalysis.role_title}
Role Level: ${selectedLevelData.label}
Interviewer: ${interviewer.interviewer_name}

ASSIGNED COMPETENCIES:
${JSON.stringify(interviewer.competencies)}

VALUES TO ASSESS:
${JSON.stringify(interviewer.values_alignment)}

YOUR TASK:
Generate 4-5 behavioral questions for this interviewer.

QUALITY CRITERIA:
1. Questions should be open-ended and natural
2. Focus on past experiences, NOT hypothetical scenarios
3. Be conversational - avoid rigid STAR format language
4. Test the assigned competencies authentically

OUTPUT FORMAT (JSON ONLY):
{
  "questions": [
    {
      "main_question": "string",
      "competency": "string",
      "value_alignment": ["value1"],
      "follow_up_probes": ["probe1", "probe2"],
      "listening_for": ["indicator1", "indicator2"],
      "red_flags": ["flag1", "flag2"]
    }
  ]
}

CRITICAL: Your ENTIRE response must be ONLY valid JSON.`
                    }
                  ]
                })
              });

              if (!response.ok) {
                throw new Error(`API request failed: ${response.status}`);
              }

              const data = await response.json();
              let responseText = data.content[0].text;
              responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
              
              const questionData = JSON.parse(responseText);
              
              stageQuestions.interviewers.push({
                interviewer_name: interviewer.interviewer_name,
                competencies: interviewer.competencies,
                values_alignment: interviewer.values_alignment,
                focus_area: interviewer.focus_area,
                questions: questionData.questions
              });
            }

            allQuestions.stages.push(stageQuestions);
          }

          setGeneratedQuestions(allQuestions);
          setStep(4);
        } catch (err) {
          setError(`Question Generation Error: ${err.message}`);
          console.error(err);
        } finally {
          setLoading(false);
        }
      };

      const runKitAssembly = async () => {
        setLoading(true);
        setError('');
        
        try {
          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 8000,
              messages: [
                {
                  role: "user",
                  content: `You are an interview experience designer. Create a complete, professional interview kit.

INPUTS:
Role Information: ${JSON.stringify(jobAnalysis, null, 2)}
Role Level: ${selectedLevelData.label}
Questions by Interviewer: ${JSON.stringify(generatedQuestions, null, 2)}

YOUR TASK:
Assemble a comprehensive interview kit document for EACH interviewer.

OUTPUT FORMAT:
Generate well-formatted markdown for each interviewer's complete kit.

Return the complete kit as formatted markdown text.`
                }
              ]
            })
          });

          if (!response.ok) {
            throw new Error(`API request failed: ${response.status}`);
          }

          const data = await response.json();
          const kitMarkdown = data.content[0].text;
          
          setFinalKits(kitMarkdown);
          setStep(5);
        } catch (err) {
          setError(`Kit Assembly Error: ${err.message}`);
          console.error(err);
        } finally {
          setLoading(false);
        }
      };

      const downloadKitPDF = async () => {
        setLoading(true);
        try {
          const simplifiedContent = generatedQuestions.stages.map((stage) => {
            return stage.interviewers.map((interviewer) => {
              const questionsText = interviewer.questions.map((q, qIdx) => {
                return `**Question ${qIdx + 1}: ${q.main_question}**\n\n*Competency:* ${q.competency}\n*Value:* ${q.value_alignment.join(', ')}\n\n*Follow-up Probes:*\n${q.follow_up_probes.map(p => `- ${p}`).join('\n')}\n\n*What to Listen For:*\n${q.listening_for.map(l => `- ${l}`).join('\n')}\n\n*Red Flags:*\n${q.red_flags.map(r => `- ${r}`).join('\n')}\n\n---\n`;
              }).join('\n');

              return `# Interview Kit: ${interviewer.interviewer_name}\n## ${stage.stage_name} - ${jobAnalysis.role_title} (Level ${roleLevel})\n\n### Focus Area\n${interviewer.focus_area}\n\n### Competencies\n${interviewer.competencies.map(c => `- ${c}`).join('\n')}\n\n### Values\n${interviewer.values_alignment.map(v => `- ${v}`).join('\n')}\n\n---\n\n## Questions\n\n${questionsText}`;
            }).join('\n\n=====\n\n');
          }).join('\n\n');

          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 8000,
              messages: [
                {
                  role: "user",
                  content: `Convert this to clean HTML for PDF printing:\n\n${simplifiedContent}\n\nReturn ONLY the complete HTML with inline CSS.`
                }
              ]
            })
          });

          const data = await response.json();
          let formattedHTML = data.content[0].text;
          
          formattedHTML = formattedHTML.replace(/```html\n?/g, "").replace(/```\n?/g, "").trim();

          const blob = new Blob([formattedHTML], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${jobAnalysis.role_title.replace(/\s+/g, '_')}_Level_${roleLevel}_Interview_Kit.html`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          alert('HTML file downloaded! Open it and print to PDF (Ctrl+P then Save as PDF)');
        } catch (err) {
          setError(`PDF Generation Error: ${err.message}`);
        } finally {
          setLoading(false);
        }
      };

      const downloadKitMarkdown = () => {
        const element = document.createElement('a');
        const file = new Blob([finalKits], { type: 'text/markdown' });
        element.href = URL.createObjectURL(file);
        element.download = `${jobAnalysis.role_title.replace(/\s+/g, '_')}_Level_${roleLevel}_Interview_Kit.md`;
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
      };

      const reset = () => {
        setStep(1);
        setJobDescription('');
        setRoleLevel('');
        setInterviewStages([
          { id: 1, name: 'Stage 1', interviewers: [{ id: 1, name: '' }] }
        ]);
        setJobAnalysis(null);
        setCompetencyMap(null);
        setGeneratedQuestions(null);
        setFinalKits(null);
        setExpandedInterviewers({});
        setError('');
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
          <div className="max-w-5xl mx-auto">
            <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
              <h1 className="text-4xl font-bold text-gray-900 mb-2">
                ETG Interview Kit Builder
              </h1>
              <p className="text-gray-600">
                AI-powered tool to create structured, value-aligned interview kits
              </p>
            </div>

            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <div className="flex items-center justify-between">
                {[
                  { num: 1, label: 'Setup', icon: 'file' },
                  { num: 2, label: 'Analysis', icon: 'target' },
                  { num: 3, label: 'Mapping', icon: 'users' },
                  { num: 4, label: 'Questions', icon: 'check' },
                  { num: 5, label: 'Final Kit', icon: 'download' }
                ].map((s, idx) => (
                  <React.Fragment key={s.num}>
                    <div className="flex flex-col items-center">
                      <div
                        className={`w-12 h-12 rounded-full flex items-center justify-center ${ 
                          step >= s.num
                            ? 'bg-indigo-600 text-white'
                            : 'bg-gray-200 text-gray-500'
                        }`}
                      >
                        <Icon type={s.icon} size={24} />
                      </div>
                      <span className="text-xs mt-2 text-gray-600">{s.label}</span>
                    </div>
                    {idx < 4 && (
                      <div
                        className={`flex-1 h-1 mx-2 ${
                          step > s.num ? 'bg-indigo-600' : 'bg-gray-200'
                        }`}
                      />
                    )}
                  </React.Fragment>
                ))}
              </div>
            </div>

            {error && (
              <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6 flex items-start gap-3">
                <Icon type="alert" />
                <div className="flex-1">
                  <h3 className="font-semibold text-red-900">Error</h3>
                  <p className="text-red-700 text-sm">{error}</p>
                </div>
              </div>
            )}

            <div className="bg-white rounded-lg shadow-lg p-8">
              {step === 1 && (
                <div className="space-y-6">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      Role Level *
                    </label>
                    <select
                      value={roleLevel}
                      onChange={(e) => setRoleLevel(e.target.value)}
                      className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                    >
                      <option value="">Select role level...</option>
                      {roleLevels.map(level => (
                        <option key={level.value} value={level.value}>
                          {level.label}
                        </option>
                      ))}
                    </select>
                    {roleLevel && selectedLevelData?.useLeadership && (
                      <p className="text-xs text-indigo-600 mt-2">
                        ✓ Leadership values will be included
                      </p>
                    )}
                  </div>

                  <div className="border-t border-gray-200 my-6"></div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      Job Description *
                    </label>
                    
                    <div className="mb-3">
                      <label className="flex items-center justify-center px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-indigo-500 cursor-pointer">
                        <Icon type="upload" className="text-gray-400 mr-2" />
                        <span className="text-sm text-gray-600">
                          Upload PDF or Word document
                        </span>
                        <input
                          type="file"
                          className="hidden"
                          accept=".pdf,.doc,.docx"
                          onChange={handleJobDescriptionFileUpload}
                          disabled={loading}
                        />
                      </label>
                      <p className="text-xs text-gray-500 mt-1">
                        Accepted formats: PDF, DOC, DOCX
                      </p>
                    </div>

                    <div className="text-center text-gray-500 text-sm my-3">or</div>

                    <textarea
                      className="w-full h-64 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                      placeholder="Paste the job description text here..."
                      value={jobDescription}
                      onChange={(e) => setJobDescription(e.target.value)}
                      disabled={loading}
                    />
                  </div>

                  <div>
                    <div className="flex items-center justify-between mb-4">
                      <label className="block text-sm font-semibold text-gray-700">
                        Interview Structure *
                      </label>
                      <button
                        onClick={addStage}
                        className="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 text-sm font-medium"
                      >
                        + Add Stage
                      </button>
                    </div>

                    {interviewStages.map((stage) => (
                      <div key={stage.id} className="mb-6 p-4 border border-gray-200 rounded-lg">
                        <div className="flex items-center justify-between mb-3">
                          <input
                            type="text"
                            className="font-semibold text-gray-900 bg-transparent border-b border-transparent hover:border-gray-300 focus:border-indigo-500 focus:outline-none"
                            value={stage.name}
                            onChange={(e) => {
                              setInterviewStages(stages =>
                                stages.map(s =>
                                  s.id === stage.id ? { ...s, name: e.target.value } : s
                                )
                              );
                            }}
                          />
                          {interviewStages.length > 1 && (
                            <button
                              onClick={() => removeStage(stage.id)}
                              className="text-red-600 hover:text-red-800 text-sm"
                            >
                              Remove Stage
                            </button>
                          )}
                        </div>

                        <div className="space-y-2">
                          {stage.interviewers.map((interviewer) => (
                            <div key={interviewer.id} className="flex items-center gap-2">
                              <input
                                type="text"
                                className="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                placeholder="Interviewer name"
                                value={interviewer.name}
                                onChange={(e) =>
                                  updateInterviewerName(stage.id, interviewer.id, e.target.value)
                                }
                              />
                              {stage.interviewers.length > 1 && (
                                <button
                                  onClick={() => removeInterviewer(stage.id, interviewer.id)}
                                  className="text-red-600 hover:text-red-800 text-sm px-2"
                                >
                                  ×
                                </button>
                              )}
                            </div>
                          ))}
                        </div>

                        <button
                          onClick={() => addInterviewer(stage.id)}
                          className="mt-2 text-indigo-600 hover:text-indigo-800 text-sm font-medium"
                        >
                          + Add Interviewer to {stage.name}
                        </button>
                      </div>
                    ))}
                  </div>

                  <button
                    onClick={runJobAnalysis}
                    disabled={!jobDescription.trim() || !roleLevel || loading}
                    className="w-full py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-300 font-semibold flex items-center justify-center gap-2"
                  >
                    {loading ? (
                      <>
                        <Icon type="loader" className="animate-spin" />
                        Processing...
                      </>
                    ) : (
                      'Start Analysis'
                    )}
                  </button>
                </div>
              )}

              {step === 2 && jobAnalysis && (
                <div className="space-y-6">
                  <h2 className="text-2xl font-bold text-gray-900">Job Analysis Complete</h2>
                  
                  <div className="bg-blue-50 p-4 rounded-lg">
                    <h3 className="font-semibold text-gray-900 mb-2">Role: {jobAnalysis.role_title}</h3>
                    <p className="text-sm text-gray-600">Level: {selectedLevelData.label}</p>
                  </div>

                  <div>
                    <h4 className="font-semibold text-gray-900 mb-2">Core Competencies</h4>
                    <div className="flex flex-wrap gap-2">
                      {jobAnalysis.core_competencies.map((comp, idx) => (
                        <span key={idx} className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm">
                          {comp}
                        </span>
                      ))}
                    </div>
                  </div>

                  <button
                    onClick={runCompetencyMapping}
                    disabled={loading}
                    className="w-full py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-300 font-semibold flex items-center justify-center gap-2"
                  >
                    {loading ? (
                      <>
                        <Icon type="loader" className="animate-spin" />
                        Mapping...
                      </>
                    ) : (
                      'Continue to Competency Mapping'
                    )}
                  </button>
                </div>
              )}

              {step === 3 && competencyMap && (
                <div className="space-y-6">
                  <h2 className="text-2xl font-bold text-gray-900">Competency Mapping Complete</h2>
                  
                  {competencyMap.stages.map((stage, idx) => (
                    <div key={idx} className="border border-gray-200 rounded-lg p-4">
                      <h3 className="font-semibold text-gray-900 mb-3">{stage.stage_name}</h3>
                      
                      {stage.interviewers.map((interviewer, intIdx) => (
                        <div key={intIdx} className="mb-4 bg-gray-50 p-3 rounded">
                          <h4 className="font-medium text-gray-900">{interviewer.interviewer_name}</h4>
                          <p className="text-sm text-gray-600 mb-2">{interviewer.focus_area}</p>
                          <div className="flex flex-wrap gap-2">
                            {interviewer.competencies.map((comp, compIdx) => (
                              <span key={compIdx} className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">
                                {comp}
                              </span>
                            ))}
                          </div>
                        </div>
                      ))}
                    </div>
                  ))}

                  <button
                    onClick={runQuestionGeneration}
                    disabled={loading}
                    className="w-full py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-300 font-semibold flex items-center justify-center gap-2"
                  >
                    {loading ? (
                      <>
                        <Icon type="loader" className="animate-spin" />
                        Generating Questions...
                      </>
                    ) : (
                      'Generate Interview Questions'
                    )}
                  </button>
                </div>
              )}

              {step === 4 && generatedQuestions && (
                <div className="space-y-6">
                  <h2 className="text-2xl font-bold text-gray-900">Questions Generated</h2>
                  
                  {generatedQuestions.stages.map((stage, stageIdx) => (
                    <div key={stageIdx} className="border border-gray-200 rounded-lg p-4">
                      <h3 className="font-semibold text-gray-900 mb-3">{stage.stage_name}</h3>
                      
                      {stage.interviewers.map((interviewer, intIdx) => {
                        const expandKey = `${stageIdx}-${intIdx}`;
                        const isExpanded = expandedInterviewers[expandKey];
                        
                        return (
                          <div key={intIdx} className="mb-4">
                            <div className="flex items-center justify-between mb-2">
                              <h4 className="font-medium text-gray-900">{interviewer.interviewer_name}</h4>
                              <button
                                onClick={() => toggleInterviewerExpansion(stageIdx, intIdx)}
                                className="text-indigo-600 hover:text-indigo-800 text-sm font-medium"
                              >
                                {isExpanded ? 'Show Less' : `Show All ${interviewer.questions.length} Questions`}
                              </button>
                            </div>
                            
                            <div className="space-y-3">
                              {(isExpanded ? interviewer.questions : interviewer.questions.slice(0, 2)).map((q, qIdx) => (
                                <div key={qIdx} className="bg-gray-50 p-3 rounded">
                                  <p className="font-medium text-sm text-gray-900 mb-2">{q.main_question}</p>
                                  <p className="text-xs text-gray-600">
                                    <span className="font-semibold">Assesses:</span> {q.competency}
                                  </p>
                                </div>
                              ))}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ))}

                  <button
                    onClick={runKitAssembly}
                    disabled={loading}
                    className="w-full py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-300 font-semibold flex items-center justify-center gap-2"
                  >
                    {loading ? (
                      <>
                        <Icon type="loader" className="animate-spin" />
                        Assembling Kits...
                      </>
                    ) : (
                      'Assemble Final Kits'
                    )}
                  </button>
                </div>
              )}

              {step === 5 && finalKits && (
                <div className="space-y-6">
                  <div className="flex items-center justify-between">
                    <h2 className="text-2xl font-bold text-gray-900">Interview Kits Ready!</h2>
                    <Icon type="check" size={32} />
                  </div>

                  <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                    <p className="text-green-900">
                      Your complete interview kits have been generated for all interviewers.
                    </p>
                  </div>

                  <div className="border border-gray-200 rounded-lg p-4 max-h-96 overflow-y-auto bg-gray-50">
                    <pre className="text-xs text-gray-800 whitespace-pre-wrap font-mono">
                      {finalKits}
                    </pre>
                  </div>

                  <div className="flex gap-3">
                    <button
                      onClick={downloadKitPDF}
                      disabled={loading}
                      className="flex-1 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 font-semibold flex items-center justify-center gap-2"
                    >
                      {loading ? (
                        <>
                          <Icon type="loader" className="animate-spin" />
                          Generating PDF...
                        </>
                      ) : (
                        <>
                          <Icon type="download" />
                          Download as PDF
                        </>
                      )}
                    </button>
                    <button
                      onClick={downloadKitMarkdown}
                      className="flex-1 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-semibold flex items-center justify-center gap-2"
                    >
                      <Icon type="download" />
                      Download as Markdown
                    </button>
                  </div>
                  
                  <button
                    onClick={reset}
                    className="w-full px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold"
                  >
                    Create New Kit
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<InterviewKitBuilder />);
  </script>
</body>
</html>